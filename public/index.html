<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAFIS - Financial Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CUSTOM CSS STYLES --- */
        body {
            font-family: "Poppins", sans-serif;
            background: radial-gradient(circle at top, #0b1d3a, #061024 80%);
            color: #f0f4ff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation Bar Styling */
        nav {
            background-color: #040d1a;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #00aaff50;
        }

        nav .nav-center {
            display: flex;
            justify-content: center;
            flex: 1;
        }

        nav a {
            color: #00ffcc;
            margin: 0 1.5rem;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: #00aaff;
            text-shadow: 0 0 5px rgba(0, 255, 204, 0.5);
        }

        #sign-out-button {
            background: linear-gradient(90deg, #ff6b6b, #ee5a52);
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        #sign-out-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }

        #sign-out-button.hidden {
            display: none;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 5rem 2rem;
            width: 100%;
        }

        /* Animated GAFIS Header */
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ffcc00; 
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7); 
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); filter: brightness(100%); }
            50% { transform: scale(1.03); filter: brightness(120%); }
            100% { transform: scale(1); filter: brightness(100%); }
        }

        /* Gradient H2 Header */
        h2 {
            font-size: 1.6rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            background: -webkit-linear-gradient(90deg, #00ffcc, #00aaff); 
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 0 5px rgba(0, 255, 204, 0.5); 
        }

        /* Buttons */
        button, .btn {
            background: linear-gradient(90deg, #00ffcc, #00aaff);
            border: none;
            padding: 0.9rem 1.8rem;
            margin: 0.5rem;
            border-radius: 12px;
            color: #041423;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 170, 255, 0.3);
            display: flex; /* Added for icon centering */
            align-items: center;
            justify-content: center;
        }

        button:hover, .btn:hover {
            transform: scale(1.05);
            background: linear-gradient(90deg, #00aaff, #00ffcc);
            box-shadow: 0 6px 20px rgba(0, 170, 255, 0.5);
        }

        .tips {
            background: rgba(16, 37, 66, 0.7); /* Darker blue background */
            border: 1px solid #00ffcc50;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 3rem;
            width: 100%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
        }

        /* Adjusted H3 for the new Tip layout */
        .tips h3 {
            font-size: 1.5rem;
            color: #ffcc00;
            /* Removed bottom padding/border as it's now a flex row */
        }
        
        .metric-label {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 2rem;
            padding: 0.5rem 1rem;
            border: 2px solid #00ffcc;
            border-radius: 8px;
            color: #00ffcc; 
            text-shadow: 0 0 8px rgba(0, 255, 204, 0.7);
            animation: pulse-border 2s infinite alternate; 
        }

        @keyframes pulse-border {
            0% { border-color: #00ffcc; box-shadow: 0 0 5px #00ffcc; }
            100% { border-color: #00aaff; box-shadow: 0 0 15px #00aaff; }
        }

        .hidden { display: none !important; }
        footer { text-align: center; padding: 1.5rem; font-size: 0.9rem; color: #9bb0cc; }
        
        .game-data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 900px;
            margin-top: 2rem;
        }
        .data-card {
            padding: 1rem;
            background: #102542;
            border-radius: 10px;
            border: 1px solid #00aaff50;
        }
        .data-card p { margin: 0; }
        .data-card .value { font-size: 1.5rem; font-weight: 700; color: #00ffcc; }
        .data-card .label { font-size: 0.9rem; color: #9bb0cc; }
        
        .about-content {
            background: rgba(16, 37, 66, 0.7);
            border: 1px solid #ffcc0050;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 3rem;
            width: 100%;
            max-width: 800px;
            text-align: left;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.1);
        }
        .about-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .about-content h3 {
            color: #00ffcc;
            font-weight: 600;
            margin-top: 1.5rem;
            border-bottom: 1px solid #00aaff50;
            padding-bottom: 0.5rem;
            font-size: 1.4rem;
        }
        
        .popup-warning {
            background: #4a0404;
            color: #ffdddd;
            border: 2px solid #ff3b3b;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 15px rgba(255, 59, 59, 0.5);
        }

        /* Choice description */
        #choice-desc {
            min-height: 2.2rem;
            transition: opacity 0.2s ease;
        }

        /* Surprise bonus popup */
        #surprise-popup {
            position: fixed;
            right: 1rem;
            top: 1rem;
            background: linear-gradient(90deg,#ffd86b,#ff6b6b);
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            color: #041423;
            font-weight: 700;
            z-index: 9999;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }

        #surprise-popup.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(.2,.8,.2,1);
        }

    </style>
</head>
<body>
    <nav>
        <div class="nav-center">
            <a id="nav-home-link" href="#">Home</a>
            <a id="nav-play-link" href="#">Play</a>
            <a id="nav-about-link" href="#">About</a>
        </div>
        <button id="sign-out-button" class="hidden">üö™ Sign Out</button>
    </nav>
    <main>
        <!-- Welcome/Login Screen -->
        <section id="welcome-screen">
            <h1>WELCOME TO GAFIS üéÆüí∞</h1>
            <h2>Learn Finance the Fun Way üí∞</h2>
            <p class="text-xl text-gray-300">Make smart money decisions through interactive challenges.</p>
            
            <div id="popup-warning" class="popup-warning hidden">
                ‚ö†Ô∏è **Sign-In Blocked!** Please check your browser's address bar and **allow pop-ups** for this site, then try clicking the button again.
            </div>

            <!-- Email input row (hidden unless runtime config missing) -->
            <div id="email-input-row" class="hidden mt-4 w-full max-w-md mx-auto">
                <label for="email-input" class="sr-only">Email for test identification</label>
                <div class="flex">
                    <input id="email-input" type="email" placeholder="Enter email to identify yourself (optional)" class="flex-1 p-2 rounded-l-md text-black" />
                    <button id="use-email-button" class="btn rounded-r-md">Use Email</button>
                </div>
                <p class="text-xs text-gray-400 mt-2">Providing an email here will derive a deterministic ID locally (not sent anywhere unless Firebase is configured).</p>
            </div>

            <div class="mt-8 flex flex-wrap justify-center space-x-4">
                <!-- Buttons link to existing JS logic using their IDs -->
                <button id="play-now-button">
                    üéØ Play Now (No Save)
                </button>
                <button id="login-button">
                    <!-- Google Icon SVG (48x48) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 mr-2" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.611 20.083H42V20h-4v2.083h-.066c-.692-2.18-1.92-4.04-3.568-5.385l2.427-2.427c3.344 3.12 5.513 7.373 5.513 12.115s-2.169 8.995-5.513 12.115l-2.427-2.427c1.648-1.345 2.876-3.205 3.568-5.385H42V28h1.611c.21-.692.387-1.4.524-2.117h-2.135V20.083z"/>
                        <path fill="#4CAF50" d="M30 44c4.872 0 9.273-1.907 12.571-5l-2.427-2.427c-2.07 1.574-4.636 2.527-7.144 2.527s-5.074-.953-7.144-2.527l-2.427 2.427c3.298 3.093 7.7 5 12.571 5z"/>
                        <path fill="#1976D2" d="M30 4h-4v2.083h.066c-.692 2.18-1.92 4.04-3.568 5.385l2.427 2.427c3.344-3.12 5.513-7.373 5.513-12.115s-2.169-8.995-5.513-12.115l-2.427 2.427c1.648 1.345 2.876 3.205 3.568 5.385H30V4z"/>
                        <path fill="#F44336" d="M30 4c-4.872 0-9.273 1.907-12.571 5l2.427 2.427c2.07-1.574 4.636-2.527 7.144-2.527s5.074-.953 7.144 2.527l2.427-2.427C39.273 5.907 34.872 4 30 4z"/>
                        <path fill="#2E7D32" d="M24 16h-4v2.083h-.066c-.692 2.18-1.92 4.04-3.568 5.385l2.427 2.427c3.344-3.12 5.513-7.373 5.513-12.115s-2.169-8.995-5.513-12.115l-2.427 2.427c1.648 1.345 2.876 3.205 3.568 5.385H24V16z"/>
                    </svg>
                    Sign in with Google (Saves Progress)
                </button>
            </div>
            
            <p id="auth-status" class="mt-4 text-sm text-yellow-400">Authenticating...</p>
            <p style="margin-top: 2rem;" class="text-gray-400">GAFIS: Where money meets mindset ‚ö°</p>

            <section class="tips">
                <div class="flex justify-between items-center mb-2 border-b border-gray-600 pb-2">
                    <h3 class="!mb-0">üí° GAFIS Tip of the Day</h3>
                    <button id="refresh-tip-button" class="bg-indigo-600 hover:bg-indigo-500 text-white font-medium text-sm py-1 px-3 rounded-lg transition duration-150 shadow-md">
                        üîÑ Refresh
                    </button>
                </div>
                <p id="current-tip" class="text-sm mt-2">
                    <!-- Tip will be injected here by JS -->
                </p>
            </section>

            <!-- Rent Selection Modal (Hidden until game starts) -->
            <div id="rent-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
                <div class="bg-blue-900 border-2 border-cyan-400 p-8 rounded-lg shadow-2xl text-center max-w-md">
                    <h2 class="text-3xl font-bold mb-4 text-yellow-300">Choose Your Living Situation üè†</h2>
                    <p class="text-white mb-6">Select your monthly rent. Higher rent = more stability but less money to invest.</p>
                    
                    <div class="space-y-3">
                        <button onclick="window.startGameWithRent(600)" class="w-full bg-gradient-to-r from-green-500 to-green-400 hover:from-green-400 hover:to-green-300 text-black font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">
                            üèòÔ∏è Budget Apartment<br/><span class="text-sm">$600/month (Riskier)</span>
                        </button>
                        <button onclick="window.startGameWithRent(800)" class="w-full bg-gradient-to-r from-cyan-400 to-blue-400 hover:from-cyan-300 hover:to-blue-300 text-black font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">
                            üè¢ Mid-Range Apartment<br/><span class="text-sm">$800/month (Balanced)</span>
                        </button>
                        <button onclick="window.startGameWithRent(1000)" class="w-full bg-gradient-to-r from-purple-500 to-pink-400 hover:from-purple-400 hover:to-pink-300 text-black font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">
                            üè∞ Nice Apartment<br/><span class="text-sm">$1000/month (Safer)</span>
                        </button>
                    </div>
                    <p class="text-gray-300 text-xs mt-4">You start with $3,000 and earn $3,500/month. Choose wisely!</p>
                </div>
            </div>
        </section>

        <!-- Main Game Screen (Initially Hidden) -->
        <section id="game-screen" class="hidden w-full max-w-4xl p-6">
            <h1 class="mb-4">GAFIS Financial Simulation</h1>
            
            <!-- Key Status -->
            <div class="metric-label mb-8">
                <p id="month-display" class="text-white text-3xl font-mono">Month: 1</p>
                <p id="user-display" class="text-sm text-gray-400 mt-2"></p>
            </div>

            <!-- Financial Metrics Grid -->
            <div class="game-data-grid">
                <!-- 1. Cash Balance -->
                <div class="data-card">
                    <p class="label">Cash Balance</p>
                    <p id="balance-display" class="value text-green-400">$1,000</p>
                </div>
                <!-- 2. Savings -->
                <div class="data-card">
                    <p class="label">Savings Account</p>
                    <p id="savings-display" class="value text-blue-400">$0</p>
                </div>
                <!-- 3. Total Investments -->
                <div class="data-card">
                    <p class="label">Total Investments</p>
                    <p id="investments-display" class="value text-yellow-400">$0</p>
                </div>
                <!-- 4. Monthly Income -->
                <div class="data-card">
                    <p class="label">Monthly Income</p>
                    <p id="income-display" class="value text-green-300">$2,500</p>
                </div>
                <!-- 5. Monthly Expenses -->
                <div class="data-card">
                    <p class="label">Monthly Expenses (Rent+Groceries)</p>
                    <p id="expenses-display" class="value text-red-300">-$1,600</p>
                </div>
                <!-- 6. Loan Debt -->
                <div class="data-card">
                    <p class="label">Loan Debt (5% APR)</p>
                    <p id="debt-display" class="value text-red-500">-$5,000</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <h2 class="mt-8 mb-4">Current Month Actions</h2>
            <div id="choices" class="flex flex-wrap justify-center space-x-4"></div>
            <div id="choice-desc" class="mt-4 text-sm text-gray-300 max-w-3xl text-center">Choose an action each month. Hover a choice to see details.</div>
            
            <h2 class="mt-8 mb-4">Advance Simulation</h2>
            <button onclick="handleAction('NextMonth')" class="bg-indigo-600 hover:bg-indigo-500">
                Advance Month & Process Finances
            </button>

            <p id="message" class="mt-8 text-lg text-red-300"></p>

            <!-- Game Over Modal (Hidden by default) -->
            <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
                <div class="bg-red-900 border-2 border-red-500 p-8 rounded-lg shadow-2xl text-center">
                    <h2 class="text-4xl font-bold mb-4 text-yellow-300">GAME OVER</h2>
                    <p id="game-over-reason" class="text-xl text-white mb-6">You failed to cover mandatory expenses this month.</p>
                    <button onclick="handleAction('Reset')" class="bg-yellow-500 hover:bg-yellow-400 text-black">Start New Game</button>
                </div>
            </div>
        </section>
        
        <!-- About Screen (Initially Hidden) -->
        <section id="about-screen" class="hidden w-full max-w-4xl p-6">
            <h1 class="mb-4">About GAFIS üìö</h1>
            <h2>The Gamified Financial Simulation</h2>

            <div class="about-content">
                <p>GAFIS (Gamified Financial Simulation) is designed to help you practice real-world personal finance decisions in a risk-free environment. By managing your income, expenses, savings, investments, and debt month-to-month, you gain practical experience on how financial choices impact your long-term wealth.</p>

                <h3>How it Works</h3>
                <p>You start with a basic financial profile. Each month, you must decide how to allocate your disposable income. Actions like **saving** and **investing** help you grow your net worth, while managing **debt** is crucial for minimizing interest payments. Be careful, as failing to cover your fixed expenses (like rent) will result in a **Game Over!**</p>
                
                <h3>Goal</h3>
                <p>The primary goal is to maximize your total net worth (Cash + Savings + Investments - Debt) over the longest period possible, while also achieving key financial milestones like paying off your loan or building a robust emergency fund.</p>

                <h3>Data Persistence</h3>
                <p class="text-sm text-gray-400 mt-4">Your game progress is securely saved using Google Firestore, tied to your unique user ID. This allows you to pick up exactly where you left off, even if you close the browser.</p>
            </div>
        </section>
    </main>
    
    <footer>
        ¬© 2025 GAFIS ‚Äî Empowering Smart Money Decisions. User ID: <span id="footer-user-id">N/A</span>
    </footer>

    <!-- Surprise bonus popup -->
    <div id="surprise-popup" aria-hidden="true">+ $0 Surprise!</div>

    <!-- Load Firebase config if available -->
    <script src="firebase-config.js"></script>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // UPDATED: Added GoogleAuthProvider and signInWithPopup for Google Auth
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // --- GLOBAL FIREBASE VARIABLES (MANDATORY) ---
        // Runtime-injectable Firebase config support
        const appIdFromGlobal = typeof __app_id !== 'undefined' ? __app_id : null;
        const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        let firebaseConfig = {};
        try { firebaseConfig = JSON.parse(rawFirebaseConfig || '{}'); } catch(e) { firebaseConfig = {}; }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let isConfigured = false; // will be set after attempting runtime injection
        let appId = appIdFromGlobal || 'default-app-id';

        // --- DAILY TIPS DATA ---
        const DAILY_TIPS = [
            "Start saving 10% of everything you earn, no matter how small the amount.",
            "Avoid impulse buying ‚Äî wait 24 hours before making any non-essential purchase.",
            "Track your expenses for a week to truly understand your current spending habits.",
            "Set a clear savings goal and give it a specific, realistic deadline.",
            "Pay yourself first: Move money to savings the very moment you get paid.",
            "Review all your monthly subscriptions and cancel any you don't use regularly.",
            "Automate your savings and debt payments to effortlessly stay on track.",
            "Invest in learning new skills ‚Äî your greatest asset is your earning potential.",
            "Always keep an emergency fund of 3-6 months of expenses in a safe savings account."
        ];
        
        // --- GAME STATE ---
        const INITIAL_GAME_STATE = {
            balance: 3000,
            savings: 0,
            month: 1,
            monthlyIncome: 3500,
            rent: 800,
            groceries: 400, // Now a monthly decision, not mandatory expense in 'NextMonth'
            investmentsValue: 0,
            loanDebt: 2000,
            isGameOver: false,
        };
        let gameState = { ...INITIAL_GAME_STATE };

        // --- FIRESTORE PATH CONSTANTS (FIXED TO ENSURE 6 SEGMENTS: C/D/C/D/C/D) ---
        const GAME_COLLECTION_NAME = 'game_data'; 
        const GAME_DOC_ID = 'financial_simulation_state'; 

        // --- TIP DISPLAY FUNCTION ---
        function displayRandomTip() {
            const tipElement = document.getElementById('current-tip');
            if (tipElement) {
                const randomIndex = Math.floor(Math.random() * DAILY_TIPS.length);
                tipElement.textContent = DAILY_TIPS[randomIndex];
            }
        }

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initializeFirebase() {
            const playNowButton = document.getElementById('play-now-button');
            const authStatusElement = document.getElementById('auth-status');
            const loginButton = document.getElementById('login-button');

            // Always enable Play Now for immediate testing, regardless of auth status
            playNowButton.disabled = false;
            // Try runtime-injected config from Hosting (quick and secure). If hosting provides
            // `/__/firebase/init.json` this will contain the project's config and we can initialize.
            async function tryRuntimeConfig() {
                try {
                    const resp = await fetch('/__/firebase/init.json');
                    if (resp && resp.ok) {
                        const init = await resp.json();
                        // Different Hosting outputs may return structure with `config` or `firebaseConfig`
                        firebaseConfig = init.config || init.firebaseConfig || init;
                        appId = init.appId || init.projectId || appId;
                    }
                } catch (e) {
                    // ignore - runtime config not available
                }
            }

            await tryRuntimeConfig();
            isConfigured = firebaseConfig && Object.keys(firebaseConfig).length > 0;

            if (!isConfigured) {
                // SCENARIO 1: TEST MODE (Firebase Config Missing)
                // Allow the user to supply an email which will be used to derive a deterministic
                // user id (SHA-256) so they can identify themselves across sessions without
                // exposing a plain UID. If the user doesn't provide an email we fall back to
                // an ephemeral random id.
                document.getElementById('email-input-row').classList.remove('hidden');
                authStatusElement.textContent = '‚ö†Ô∏è Running in TEST MODE (No persistence). Enter email to identify yourself, or click Play Now to start a temporary game.';
                document.getElementById('footer-user-id').textContent = 'TEST_MODE';

                loginButton.disabled = true; // Disable Google button since it won't work without config
                loginButton.classList.add('opacity-50', 'cursor-not-allowed');

                gameState = { ...INITIAL_GAME_STATE };
                updateUI("Game Ready in Test Mode (Data will not be saved).");
                isAuthReady = true;
                displayRandomTip(); // Display first tip
                return; // Stop Firebase initialization
            }


            // SCENARIO 2: STANDARD MODE (Firebase Config Present)
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Set up state listener
                onAuthStateChanged(auth, async (user) => {
                    const signOutBtn = document.getElementById('sign-out-button');
                    if (user) {
                        // Use user.uid for persistence
                        userId = user.uid; 
                        authStatusElement.textContent = `‚úÖ Signed in. Player ID: ${userId.substring(0, 8)}...`;
                        document.getElementById('footer-user-id').textContent = userId;
                        
                        // Show sign-out button when user is logged in
                        if (signOutBtn) signOutBtn.classList.remove('hidden');
                        
                        // Ensure buttons are correctly enabled/disabled
                        loginButton.disabled = false;
                        loginButton.classList.remove('opacity-50', 'cursor-not-allowed');

                        await loadGameState();
                    } else {
                        // User is signed out or initial anonymous/token failed
                        userId = null;
                        authStatusElement.textContent = 'Ready. Please sign in with Google to save your progress.';
                        
                        // Hide sign-out button when user is not logged in
                        if (signOutBtn) signOutBtn.classList.add('hidden');
                        
                        // Keep Play Now enabled
                    }
                    isAuthReady = true;
                    displayRandomTip(); // Display first tip once authenticated state is set
                });
                
                // 2. Initial sign-in attempt (either with provided token or anonymously)
                authStatusElement.textContent = 'Attempting initial anonymous sign-in...';
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                authStatusElement.textContent = `‚ùå Auth Error: ${error.message}`;
                // Fallback to test mode behavior if standard auth fails
                userId = crypto.randomUUID(); 
                isAuthReady = true;
                gameState = { ...INITIAL_GAME_STATE };
            }
        }

        // --- EMAIL -> USER ID UTIL ---
        async function emailToId(email) {
            if (!email) return null;
            const encoder = new TextEncoder();
            const data = encoder.encode(email.trim().toLowerCase());
            const hash = await crypto.subtle.digest('SHA-256', data);
            const bytes = Array.from(new Uint8Array(hash));
            const hex = bytes.map(b => b.toString(16).padStart(2, '0')).join('');
            // Use a truncated hex (first 24 chars) to keep IDs shorter
            return `email_${hex.substring(0,24)}`;
        }

        // --- UI & STATE MANAGEMENT ---

        function updateUI(message = "") {
            document.getElementById('balance-display').textContent = `$${gameState.balance.toLocaleString()}`;
            document.getElementById('savings-display').textContent = `$${gameState.savings.toLocaleString()}`;
            document.getElementById('investments-display').textContent = `$${gameState.investmentsValue.toLocaleString()}`;
            document.getElementById('debt-display').textContent = `-$${gameState.loanDebt.toLocaleString()}`;
            
            const totalFixedExpense = gameState.rent;
            document.getElementById('expenses-display').textContent = `-$${totalFixedExpense.toLocaleString()}`;
            document.getElementById('income-display').textContent = `$${gameState.monthlyIncome.toLocaleString()}`;

            document.getElementById('month-display').textContent = `Month: ${gameState.month}`;
            document.getElementById('message').textContent = message;
            document.getElementById('user-display').textContent = `Player: ${userId ? userId.substring(0, 8) : 'Guest'}`;
            
            // Handle Game Over Screen
            document.getElementById('game-over-modal').classList.toggle('hidden', !gameState.isGameOver);

            // Disable all action buttons if game is over
            document.querySelectorAll('#choices button, #game-screen button[onclick="handleAction(\'NextMonth\')"]').forEach(btn => {
                btn.disabled = gameState.isGameOver;
                btn.classList.toggle('opacity-50', gameState.isGameOver);
                btn.classList.toggle('cursor-not-allowed', gameState.isGameOver);
            });
        }

        function showScreen(screenId) {
            // Get all main sections
            const screens = ['welcome-screen', 'game-screen', 'about-screen'];
            
            // Hide all main sections
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Show the requested section
            const requestedScreen = document.getElementById(screenId);
            if (requestedScreen) {
                requestedScreen.classList.remove('hidden');
            }

            // If switching to game, ensure UI is updated and show choices
            if (screenId === 'game-screen') {
                updateUI();
                generateMonthlyChoices();
            }
        }

        // --- Surprise popup helper ---
        function showSurprise(amount) {
            const el = document.getElementById('surprise-popup');
            if (!el) return;
            el.textContent = `üéâ Surprise bonus: +$${amount}`;
            el.classList.add('show');
            el.setAttribute('aria-hidden','false');
            setTimeout(() => {
                el.classList.remove('show');
                el.setAttribute('aria-hidden','true');
            }, 3500);
        }

        // --- BUTTON HANDLERS ---

        function handleLoginButton() {
            const authStatusElement = document.getElementById('auth-status');
            const popupWarning = document.getElementById('popup-warning');
            
            // Hide any previous warnings
            popupWarning.classList.add('hidden'); 

            if (!isAuthReady) {
                authStatusElement.textContent = "Still connecting to the server. Please wait a moment.";
                return;
            }

            if (!isConfigured) {
                 authStatusElement.textContent = "‚ùå Sign-in failed: Firebase configuration missing (running in local/test mode).";
                 return;
            }

            // Proceed with Google Sign-In (this handles both new sign-ups and existing sign-ins)
            const provider = new GoogleAuthProvider();
            authStatusElement.textContent = 'Launching Google Sign-In pop-up...';

            signInWithPopup(auth, provider)
                .then((result) => {
                    // The onAuthStateChanged listener handles the rest
                    console.log("Google Sign-In successful:", result.user.uid);
                    authStatusElement.textContent = `Signed in as ${result.user.displayName || 'User'}! Loading game...`;
                })
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    let errorMessage = error.message;

                    // Improved error handling for common issues
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in cancelled. Pop-up closed by user.';
                    } else if (error.code === 'auth/popup-blocked') {
                        // Display the prominent on-screen warning
                        popupWarning.classList.remove('hidden'); 
                        errorMessage = 'Pop-up blocked by your browser. Please allow pop-ups for this site.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Please try signing in again (request was interrupted).';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = 'Domain not authorized for sign-in. This is a configuration error.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your internet connection.';
                    }
                    
                    authStatusElement.textContent = `‚ùå Sign-in Error: ${errorMessage}`;
                });
        }

        function handlePlayNowButton() {
            // This button now shows the rent selection modal
            document.getElementById('rent-selection-modal').classList.remove('hidden');
        }

        window.startGameWithRent = function(selectedRent) {
            // Set the rent and update starting balance if needed
            gameState = { ...INITIAL_GAME_STATE };
            gameState.rent = selectedRent;
            
            // Close rent modal and show game screen
            document.getElementById('rent-selection-modal').classList.add('hidden');
            showScreen('game-screen');
            updateUI(`Game started! You chose $${selectedRent}/month rent. Good luck!`);
        }

        function handleSignOut() {
            if (!auth) return;
            signOut(auth).then(() => {
                // onAuthStateChanged listener will handle the UI update
                showScreen('welcome-screen');
            }).catch((error) => {
                console.error("Sign-out error:", error);
            });
        }

        // --- FIRESTORE I/O ---

        /**
         * Constructs the Firestore Document Reference using 6 segments:
         * /artifacts/{appId}/users/{userId}/game_data/financial_simulation_state
         */
        function getGameDocRef() {
            // Only proceed if db is initialized and userId exists (i.e., not initial unauthenticated state)
            if (!db || !appId || !userId || !isConfigured) {
                return null;
            }
             return doc(
                db, 
                'artifacts', appId, 
                'users', userId, 
                GAME_COLLECTION_NAME, GAME_DOC_ID
            );
        }

        async function saveGameState() {
            if (!userId || !db || !isConfigured || !auth.currentUser) return; // Skip if unauthenticated or in Test Mode
            const userDocRef = getGameDocRef();
            if (!userDocRef) return; // Guard against null reference
            
            try {
                // Only save serializable data
                const stateToSave = { 
                    balance: gameState.balance, 
                    savings: gameState.savings, 
                    month: gameState.month, 
                    monthlyIncome: gameState.monthlyIncome, 
                    rent: gameState.rent, 
                    groceries: gameState.groceries, 
                    investmentsValue: gameState.investmentsValue, 
                    loanDebt: gameState.loanDebt,
                    isGameOver: gameState.isGameOver 
                };
                await setDoc(userDocRef, stateToSave, { merge: true });
            } catch (error) {
                console.error("Error saving game state:", error);
            }
        }

        async function loadGameState() {
            if (!userId || !db || !isConfigured || !auth.currentUser) return; // Skip if unauthenticated or in Test Mode
            const userDocRef = getGameDocRef();
            if (!userDocRef) return; // Guard against null reference

            // Check if user is authenticated via Google (or custom token) before snapshot
            if (auth.currentUser.isAnonymous) {
                // User is anonymous, only allow snapshot if this is the required flow, but usually loading is tied to persistence.
                // For this app, we prioritize Google Sign-In for persistence.
                return;
            }

            onSnapshot(userDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    gameState = { ...INITIAL_GAME_STATE, ...data }; 
                } else {
                    // Save initial state if no data exists
                    saveGameState();
                }
                updateUI("Game Loaded!");
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }

        // --- GAME LOGIC ---

        // Generate month-specific choice buttons
        function generateMonthlyChoices() {
            const choicesEl = document.getElementById('choices');
            if (!choicesEl) return;
            choicesEl.innerHTML = ''; // clear previous

            const month = gameState.month;
            const createBtn = (label, action, desc = '', cls = '') => {
                const btn = document.createElement('button');
                btn.textContent = label;
                btn.className = cls || '';
                btn.dataset.desc = desc || '';
                btn.addEventListener('click', () => window.handleAction(action));
                btn.addEventListener('mouseenter', () => {
                    const d = document.getElementById('choice-desc');
                    if (d) d.textContent = desc || '';
                });
                btn.addEventListener('focus', () => {
                    const d = document.getElementById('choice-desc');
                    if (d) d.textContent = desc || '';
                });
                btn.addEventListener('mouseleave', () => {
                    const d = document.getElementById('choice-desc');
                    if (d) d.textContent = 'Choose an action each month. Hover a choice to see details.';
                });
                choicesEl.appendChild(btn);
            };

            // Early game choices
            if (month <= 3) {
                createBtn('Take Side Job (+$600 now)', 'SideJob', 'Earn quick cash by doing a short side job ‚Äî immediate income but no long-term benefit.');
                createBtn('Pay for Skill Course (-$400 ‚Üí +$150/mo)', 'Course', 'Invest in a short course: pay now, increase monthly income thereafter.');
                createBtn('Build Emergency Fund (-$300 ‚Üí move to savings)', 'EmergencyFund', 'Add to emergency savings to protect against unexpected shortfalls.');
            } else if (month <= 6) {
                createBtn('Pay Extra on Loan (-$500)', 'PayLoanExtra', 'Reduce your loan balance to save on interest over time.');
                createBtn('Buy Dividend Asset (-$500)', 'BuyDividend', 'Purchase a dividend-paying asset for long-term passive income.');
                createBtn('Sell Some Investments (+cash)', 'SellInvestments', 'Liquidate a portion of investments to increase immediate cash.');
            } else if (month <= 12) {
                createBtn('Take Freelance Contract (+$900 now)', 'SideJobBig', 'Higher-paying contract work ‚Äî boosts cash but takes time.');
                createBtn('Refinance Loan (swap -$1000 now reduce debt by $1100)', 'Refinance', 'Pay an upfront fee to reduce your overall loan balance.');
                createBtn('Luxury Purchase (-$700, morale)', 'Luxury', 'Treat yourself ‚Äî no financial benefit, but morale (flavor) increases.');
            } else {
                createBtn('High-Risk Investment (-$700)', 'HighRiskInvest', 'Risky, high-variance investment ‚Äî can pay off or lose money.');
                createBtn('Pay Down Debt Aggressively (-$1000)', 'PayLoanExtraBig', 'Aggressively reduce loan principal to minimize interest costs.');
                createBtn('Diversify into Bonds (-$500)', 'BuyDividend', 'Add lower-risk assets to balance your portfolio.');
            }
        }

        window.handleAction = function(actionType) {
            let message = "";
            if (gameState.isGameOver && actionType !== 'Reset') {
                message = "The game is over. Please click 'Start New Game' to continue.";
                updateUI(message);
                return;
            }

            switch (actionType) {
                case 'Groceries': {
                    const groceriesCost = 400;
                    if (gameState.balance >= groceriesCost) {
                        gameState.balance -= groceriesCost;
                        message = `-$${groceriesCost}: Bought groceries for the month.`;
                    } else {
                        message = `You need $${groceriesCost} to buy groceries!`;
                    }
                    break;
                }
                case 'Save': {
                    const amountToMove = 500;
                    if (gameState.balance >= amountToMove) {
                        gameState.balance -= amountToMove;
                        gameState.savings += amountToMove;
                        message = `-$${amountToMove}: Transferred funds to savings.`;
                    } else {
                        message = "Not enough cash to transfer to savings.";
                    }
                    break;
                }
                case 'Invest': {
                    const investmentAmount = 500;
                    if (gameState.balance >= investmentAmount) {
                        gameState.balance -= investmentAmount;
                        gameState.investmentsValue += investmentAmount;
                        message = `-$${investmentAmount}: Invested in the market. Value will adjust next month.`;
                    } else {
                        message = `Investment requires $${investmentAmount}.`;
                    }
                    break;
                }
                case 'PayDebt': {
                    const debtPayment = 500;
                    if (gameState.balance >= debtPayment) {
                        gameState.balance -= debtPayment;
                        gameState.loanDebt -= debtPayment;
                        if (gameState.loanDebt < 0) gameState.loanDebt = 0;
                        message = `-$${debtPayment}: Paid down loan debt!`;
                    } else {
                        message = `You need $${debtPayment} to make a debt payment.`;
                    }
                    break;
                }

                // New choices
                case 'SideJob': {
                    const earn = 600;
                    gameState.balance += earn;
                    message = `+$${earn}: Completed a side job.`;
                    break;
                }
                case 'SideJobBig': {
                    const earn = 900;
                    gameState.balance += earn;
                    message = `+$${earn}: Freelance contract completed.`;
                    break;
                }
                case 'Course': {
                    const cost = 400;
                    if (gameState.balance >= cost) {
                        gameState.balance -= cost;
                        gameState.monthlyIncome += 150;
                        message = `-$${cost}: Took a course. Monthly income +$150.`;
                    } else {
                        message = 'Not enough cash for the course.';
                    }
                    break;
                }
                case 'EmergencyFund': {
                    const amt = 300;
                    if (gameState.balance >= amt) {
                        gameState.balance -= amt;
                        gameState.savings += amt;
                        message = `-$${amt}: Added to emergency savings.`;
                    } else {
                        message = 'Not enough cash to build emergency fund.';
                    }
                    break;
                }
                case 'SellInvestments': {
                    const sell = Math.min( Math.round(gameState.investmentsValue * 0.25), gameState.investmentsValue );
                    if (sell > 0) {
                        gameState.investmentsValue -= sell;
                        gameState.balance += sell;
                        message = `+$${sell}: Sold some investments for cash.`;
                    } else {
                        message = 'No investments available to sell.';
                    }
                    break;
                }
                case 'BuyDividend': {
                    const cost = 500;
                    if (gameState.balance >= cost) {
                        gameState.balance -= cost;
                        // Represent dividend as small savings-like value
                        gameState.investmentsValue += cost;
                        message = `-$${cost}: Bought dividend asset (long-term).`;
                    } else {
                        message = 'Not enough cash to buy asset.';
                    }
                    break;
                }
                case 'Refinance': {
                    const cost = 1000;
                    if (gameState.balance >= cost) {
                        gameState.balance -= cost;
                        gameState.loanDebt = Math.max(0, gameState.loanDebt - 1100);
                        message = `-$${cost}: Refinance processed; loan reduced.`;
                    } else {
                        message = 'Not enough cash to refinance.';
                    }
                    break;
                }
                case 'Luxury': {
                    const cost = 700;
                    if (gameState.balance >= cost) {
                        gameState.balance -= cost;
                        message = `-$${cost}: Luxury purchase. Enjoy!`;
                    } else {
                        message = 'Not enough cash for luxury purchase.';
                    }
                    break;
                }
                case 'HighRiskInvest': {
                    const cost = 700;
                    if (gameState.balance >= cost) {
                        gameState.balance -= cost;
                        // High risk: immediate random multiplier
                        const ret = Math.round(cost * (Math.random() * 1.5 - 0.5));
                        gameState.investmentsValue += Math.max(0, cost + ret);
                        message = `-$${cost}: High-risk investment placed.`;
                    } else {
                        message = 'Not enough cash for high-risk investment.';
                    }
                    break;
                }
                case 'PayLoanExtra': {
                    const pay = 500;
                    if (gameState.balance >= pay) {
                        gameState.balance -= pay;
                        gameState.loanDebt -= pay;
                        if (gameState.loanDebt < 0) gameState.loanDebt = 0;
                        message = `-$${pay}: Extra loan payment made.`;
                    } else {
                        message = 'Not enough cash to pay extra on loan.';
                    }
                    break;
                }
                case 'PayLoanExtraBig': {
                    const pay = 1000;
                    if (gameState.balance >= pay) {
                        gameState.balance -= pay;
                        gameState.loanDebt -= pay;
                        if (gameState.loanDebt < 0) gameState.loanDebt = 0;
                        message = `-$${pay}: Large loan payment made.`;
                    } else {
                        message = 'Not enough cash to pay extra on loan.';
                    }
                    break;
                }
                case 'NextMonth': {
                    const fixedExpenses = gameState.rent;
                    let nextMonthMessage = `Month ${gameState.month} Financial Report:\n`;

                    // 1. Check for Game Over before processing expenses
                    if (gameState.balance < fixedExpenses) {
                        gameState.isGameOver = true;
                        document.getElementById('game-over-reason').textContent = `You couldn't cover the mandatory $${fixedExpenses.toLocaleString()} rent expense.`;
                        message = "GAME OVER triggered.";
                        break; // Stop processing the month
                    }

                    // 2. Process Expenses and Income
                    gameState.balance -= fixedExpenses;
                    gameState.balance += gameState.monthlyIncome;
                    nextMonthMessage += `+ $${gameState.monthlyIncome.toLocaleString()} Income, - $${fixedExpenses.toLocaleString()} Rent/Fixed Costs.\n`;

                    // 3. Savings Interest
                    const savingsInterest = Math.round(gameState.savings * 0.002); // 0.2% monthly
                    gameState.savings += savingsInterest;
                    nextMonthMessage += `+ $${savingsInterest.toLocaleString()} earned from Savings Interest.\n`;

                    // 4. Investment Performance ‚Äî volatility increases slightly over time
                    const volatility = 0.05 + Math.min(0.05, gameState.month * 0.001); // grows slowly
                    const investmentReturnRate = (Math.random() * (volatility + 0.01)) - 0.02; 
                    const investmentChange = Math.round(gameState.investmentsValue * investmentReturnRate);
                    gameState.investmentsValue += investmentChange;
                    const changeType2 = investmentChange >= 0 ? 'Gained' : 'Lost';
                    nextMonthMessage += `${changeType2} $${Math.abs(investmentChange).toLocaleString()} on Investments (${(investmentReturnRate * 100).toFixed(2)}%).\n`;

                    // 5. Debt Interest
                    if (gameState.loanDebt > 0) {
                        const debtInterest = Math.round(gameState.loanDebt * 0.004); // 0.4% monthly interest
                        gameState.loanDebt += debtInterest;
                        nextMonthMessage += `-$${debtInterest.toLocaleString()} added to Loan Debt (interest).\n`;
                    }

                    // Hidden: surprise reward every 3 months (player won't see it's a pattern)
                    if ((gameState.month % 3) === 0) {
                        const bonus = Math.round(300 + Math.random() * 600); // 300-900
                        gameState.balance += bonus;
                        nextMonthMessage += `\nA surprise bonus arrived: +$${bonus}!`;
                        // show animated popup
                        try { showSurprise(bonus); } catch (e) { /* ignore */ }
                    }

                    // Difficulty scaling: rent increases slightly every 6 months
                    if (gameState.month > 0 && (gameState.month % 6) === 0) {
                        gameState.rent = Math.round(gameState.rent * 1.05);
                        nextMonthMessage += `\nYour rent increased slightly to $${gameState.rent}.`;
                    }

                    // 6. Advance Month
                    gameState.month += 1;
                    message = nextMonthMessage;
                    break;
                }

                case 'Reset': {
                    gameState = { ...INITIAL_GAME_STATE };
                    gameState.isGameOver = false;
                    message = "Game reset. Starting from Month 1.";
                    break;
                }
            }

            // Ensure no metrics drop below zero unnecessarily
            if (gameState.savings < 0) gameState.savings = 0;
            if (gameState.investmentsValue < 0) gameState.investmentsValue = 0;
            if (gameState.loanDebt < 0) gameState.loanDebt = 0;

            updateUI(message);
            saveGameState();

            // After processing a month, generate new monthly choices
            generateMonthlyChoices();
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('login-button').addEventListener('click', handleLoginButton);
        document.getElementById('play-now-button').addEventListener('click', (e) => {
            e.preventDefault();
            handlePlayNowButton();
        });
        
        // Navigation links now use the new showScreen function
        document.getElementById('nav-home-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('welcome-screen');
        });
        document.getElementById('nav-play-link').addEventListener('click', (e) => {
            e.preventDefault();
            handlePlayNowButton(); // This now calls showScreen('game-screen') internally
        });
        document.getElementById('nav-about-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('about-screen');
        });

        document.getElementById('refresh-tip-button').addEventListener('click', displayRandomTip);
        
        // Wire the sign-out button
        const signOutBtn = document.getElementById('sign-out-button');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', handleSignOut);
        }
        
        // Wire the email button (for Test Mode identity)
        const useEmailBtn = document.getElementById('use-email-button');
        if (useEmailBtn) {
            useEmailBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const emailVal = (document.getElementById('email-input') || {}).value || '';
                const authStatusEl = document.getElementById('auth-status');
                if (!emailVal || !emailVal.includes('@')) {
                    if (authStatusEl) authStatusEl.textContent = 'Please enter a valid email address.';
                    return;
                }
                const derived = await emailToId(emailVal);
                if (derived) {
                    userId = derived;
                    document.getElementById('footer-user-id').textContent = `guest:${userId.substring(0,12)}`;
                    document.getElementById('email-input-row').classList.add('hidden');
                    if (authStatusEl) authStatusEl.textContent = 'Using provided email for local identity (TEST MODE). Click Play Now.';
                    isAuthReady = true;
                    updateUI('Ready with provided email (Test Mode).');
                }
            });
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>